---
- name: DÃ©ploiement local avec Docker Compose
  hosts: local
  connection: local
  gather_facts: false

  vars:
    compose_file: "{{ playbook_dir }}/../docker-compose.yml"

  tasks:
    - name: "â¬‡ï¸  ArrÃªter et supprimer les anciens conteneurs"
      ansible.builtin.shell: docker-compose -f {{ compose_file }} down
      args:
        chdir: "{{ playbook_dir }}/.."

    - name: "ğŸ“¦ Pull des derniÃ¨res images (si vous en avez)"
      ansible.builtin.shell: docker-compose -f {{ compose_file }} pull
      args:
        chdir: "{{ playbook_dir }}/.."
      ignore_errors: yes

    - name: "ğŸš€ DÃ©marrage des services en mode dÃ©tachÃ©"
      ansible.builtin.shell: docker-compose -f {{ compose_file }} up -d
      args:
        chdir: "{{ playbook_dir }}/.."

    - name: "ğŸ” VÃ©rifier que le conteneur PHP est bien UP"
      ansible.builtin.shell: docker ps --filter "name=php" --filter "status=running" --format '{{ "{{.Names}}" }}'
      register: php_containers

    - name: "âŒ Erreur si PHP n'est pas dÃ©marrÃ©"
      ansible.builtin.fail:
        msg: "Le conteneur PHP n'est pas lancÃ© !"
      when: php_containers.stdout == ""
